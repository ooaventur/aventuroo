<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AventurOO • Article</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS / Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css">

  <!-- Canonical (ndryshohet në runtime me JS nëse ka slug) -->
  <link id="canonical" rel="canonical" href="https://aventuroo.netlify.app/article.html">

  <!-- Open Graph / Twitter (plotësohen në runtime) -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="AventurOO • Article">
  <meta property="og:description" content="Read a curated story from AventurOO.">
  <meta property="og:url" content="https://aventuroo.netlify.app/article.html">
  <meta property="og:image" content="https://aventuroo.netlify.app/assets/img/og-default.jpg">
  <meta name="twitter:card" content="summary_large_image">
</head>
<body>
<div id="site-header"></div>

<div class="ad-box text-center py-3">
  <div class="container"><div class="py-3">[728×90 Banner Ad Placeholder]</div></div>
</div>

<main class="container my-4" id="main">
  <nav class="small mb-3">
    <a class="link-secondary text-decoration-none" href="index.html">Home</a>
    <span class="mx-1">/</span>
    <span id="crumb-cat">Article</span>
  </nav>

  <article id="article" class="row g-4 d-none">
    <div class="col-lg-8">
      <img id="cover" class="hero-img" src="" alt="">
      <div class="mt-3">
        <span id="cat" class="badge badge-cat">Travel</span>
        <h1 id="title" class="fw-bold mt-2 reveal-up"></h1>
        <p id="meta" class="muted mb-2"></p>

        <div id="body" class="lead"></div>

        <blockquote class="blockquote my-4 p-3 border-start border-3" style="border-color: var(--brand)!important">
          <p class="mb-0">“Travel leaves you speechless, then turns you into a storyteller.”</p>
          <footer class="blockquote-footer mt-1">Ibn Battuta</footer>
        </blockquote>
      </div>
    </div>

    <aside class="col-lg-4">
      <div class="ad-box rounded-4 d-flex align-items-center justify-content-center mb-3" style="height:250px;">[300×250 Ad]</div>
      <div class="card border-0 shadow-soft mb-3">
        <div class="card-body">
          <div class="small text-uppercase text-muted mb-2">You might also like</div>
          <ul id="related" class="list-unstyled small mb-0"></ul>
        </div>
      </div>
      <div class="ad-box rounded-4 d-flex align-items-center justify-content-center" style="height:600px;">[300×600 Skyscraper Ad]</div>
    </aside>
  </article>

  <!-- 404 i butë -->
  <section id="empty" class="text-center text-muted py-5 d-none">
    <h1 class="h3 mb-2">Article not found</h1>
    <p>We couldn’t find that story. Try the latest posts instead.</p>
    <a class="btn btn-brand mt-2" href="index.html">Go to Home</a>
  </section>
</main>

<div id="site-footer"></div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/site.js"></script>
<script src="assets/js/animate.js"></script>
<script>
  // header/footer
  renderHeader(''); 
  renderFooter();

  // helpers
  function qs(key){const u=new URL(location.href);return u.searchParams.get(key)||"";}
  function para(t){ return `<p class="mt-3">${t}</p>`; }
  function formatDate(s){ try{const d=new Date(s); return d.toLocaleDateString('sq-AL',{year:'numeric',month:'long',day:'2-digit'});}catch{return s||'';} }
  function titleCase(s){ return (s||'').slice(0,1).toUpperCase()+ (s||'').slice(1); }

  async function load(){
    const slug = qs('slug');

    // Merre posts.json
    const res = await fetch('data/posts.json',{cache:'no-store'});
    const posts = res.ok ? await res.json() : [];

    // Zgjedh artikullin: slug → ndryshe i pari; nëse s’ka fare, 404
    let p = posts.find(x => x.slug === slug);
    if(!p && posts.length) p = posts[0];

    if(!p){
      document.getElementById('empty').classList.remove('d-none');
      return;
    }

    // Vendos të dhënat në UI
    const artEl = document.getElementById('article');
    artEl.classList.remove('d-none');

    const cat = (p.category||'').toLowerCase();
    const catNice = titleCase(cat);
    document.getElementById('crumb-cat').innerHTML = `<a class="link-secondary text-decoration-none" href="${cat}.html">${catNice}</a> / <span>${p.title}</span>`;

    const cover = document.getElementById('cover');
    cover.src = p.cover || 'assets/img/placeholder-1200x600.jpg';
    cover.alt = p.title || 'AventurOO Article';

    document.getElementById('cat').textContent = catNice || 'Article';
    document.getElementById('title').textContent = p.title || 'Untitled';
    const author = p.author || 'AventurOO Editorial';
    document.getElementById('meta').textContent = `${formatDate(p.date)} · ${author}`;

    // Trupi: p.body (HTML) ose p.content (tekst i ndarë). Pa lorem ipsum.
    const bodyEl = document.getElementById('body');

    function buildParagraphs(txt) {
      const parts = (txt || "")
        .split(/\n{2,}/)            // ndaj me boshllëqe të dyfishta (paragrafë)
        .map(s => s.trim())
        .filter(Boolean);
      return parts.map(p => `<p class="mt-3">${p}</p>`).join('');
    }

    // 1) Vendos përmbajtjen
    if (p.body) {
      bodyEl.innerHTML = p.body;            // HTML i përftuar nga autoposteri (paragrafë, img, bold, linke)
    } else if (p.content) {
      bodyEl.innerHTML = buildParagraphs(p.content);
    } else {
      bodyEl.innerHTML = `<p class="mt-3">${p.excerpt || ''}</p>`;
    }

    // 2) Post-procesim i lehtë për UX/SEO
    //    - imazhe responsive
    //    - iframes në container të sigurt
    //    - linke të jashtme hapen në tab të ri + rel="nofollow noopener"
    (() => {
      // imazhet
      bodyEl.querySelectorAll('img').forEach(img => {
        img.classList.add('img-fluid', 'rounded-3', 'my-3');
        if (!img.alt) img.alt = p.title || 'Image';
        // shmangje stretching të tepërt
        img.loading = 'lazy';
        img.decoding = 'async';
        img.referrerPolicy = 'no-referrer';
      });

      // iframes
      bodyEl.querySelectorAll('iframe').forEach(f => {
        f.classList.add('w-100', 'my-3');
        f.setAttribute('loading','lazy');
        // opsionale: vendos një aspect ratio wrapper nëse do
      });

      // linke
      const thisHost = location.host.replace(/^www\./,'');
      bodyEl.querySelectorAll('a[href]').forEach(a => {
        try {
          const u = new URL(a.href, location.href);
          const isExternal = u.host.replace(/^www\./,'') !== thisHost;
          if (isExternal) {
            a.target = '_blank';
            a.rel = 'nofollow noopener';
          }
        } catch(e) {}
      });
    })();

    // 3) Shto "Read the original" në fund nëse body s’e ka tashmë dhe ekziston p.source
    if (p.source && !/Source:|Read the full article/i.test(bodyEl.innerHTML)) {
      const srcBlock = document.createElement('p');
      srcBlock.className = 'small text-muted mt-4';
      srcBlock.innerHTML = `Read the original &rarr; <a href="${p.source}" target="_blank" rel="nofollow noopener">Open source</a>`;
      bodyEl.appendChild(srcBlock);
    }

    // Related: të së njëjtës kategori, jo i njëjti slug; shuffle të lehtë; deri 6
    const rel = posts.filter(x => (x.category||'').toLowerCase()===cat && x.slug!==p.slug);
    for (let i=rel.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [rel[i],rel[j]]=[rel[j],rel[i]]; }
    const related = rel.slice(0,6).map(r => `
      <li class="mb-2">
        <a class="link-secondary text-decoration-none" href="article.html?slug=${r.slug}">${r.title}</a>
        <div class="text-muted">${r.date||''}</div>
      </li>`).join('');
    document.getElementById('related').innerHTML = related || `<li class="text-muted">No related posts yet.</li>`;


    // ---- SEO: përditëso meta/OG/Canonical ----
    const base = "https://aventuroo.netlify.app";
    const url  = `${base}/article.html?slug=${encodeURIComponent(p.slug)}`;
    const title = p.title ? `${p.title} • AventurOO` : 'AventurOO • Article';
    const desc  = (p.excerpt||'').slice(0,160);
    const img   = p.cover || `${base}/assets/img/og-default.jpg`;

    document.title = title;
    document.querySelector('meta[property="og:title"]').setAttribute('content', title);
    document.querySelector('meta[property="og:description"]').setAttribute('content', desc);
    document.querySelector('meta[property="og:url"]').setAttribute('content', url);
    document.querySelector('meta[property="og:image"]').setAttribute('content', img);
    document.getElementById('canonical').setAttribute('href', url);

    // JSON-LD (Article)
    const ld = {
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": p.title,
      "datePublished": p.date || "",
      "author": { "@type": "Person", "name": author },
      "image": [ img ],
      "mainEntityOfPage": { "@type": "WebPage", "@id": url }
    };
    const ldTag = document.createElement('script');
    ldTag.type = 'application/ld+json';
    ldTag.textContent = JSON.stringify(ld);
    document.head.appendChild(ldTag);
  }

  load();
</script>
</body>
</html>
